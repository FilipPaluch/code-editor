<div class="chat-container">
    <div class="message-list" #messageList>
        @for(message of messages(); track message; let i = $index) {
            <div class="message" 
                [class.user-message]="message.isUser" 
                [class.ai-message]="!message.isUser"
                [attr.data-streaming]="message.isStreaming()">
                <div class="message-content">
                    @for(fragment of message.text() | markdownParser; track fragment) {
                        @if(fragment.type === 'text') {
                            <div class="text-fragment" [innerHTML]="fragment.content"></div>
                        } @else if(fragment.type === 'code') {
                            <app-code-card 
                                [code]="fragment.content" 
                                [language]="fragment.language || 'expression'">
                            </app-code-card>
                        }
                    }
                </div>
            </div>
        }
    </div>

    <div class="chat-input-area">
        <div class="chat-form">
            <textarea 
                #chatTextarea
                [(ngModel)]="userInput" 
                (input)="adjustTextareaHeight(chatTextarea)"
                name="userInput"
                class="chat-input" 
                placeholder="Describe what you want to build..."
                (keydown.enter)="sendMessage(); $event.preventDefault()" 
                [disabled]="isLoading()">
            </textarea>

            <div class="button-group">
                <button
                    class="send-button"
                    [disabled]="isLoading()"
                    (click)="sendMessage()">
                    {{ isLoading() ? 'Sending...' : 'Send' }}
                </button>

                @if(isLoading()) {
                    <button
                        class="stop-button"
                        (click)="cancelStream()">
                        Stop
                    </button>
                }
            </div>
        </div>

        <p class="disclaimer">
            AI can make mistakes. Please review all generated code.
        </p>
    </div>
</div>